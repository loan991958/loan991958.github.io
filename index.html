<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with foreigners </title>
<style>
body {
    background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
    color: #fff;
    font: 1rem/1 'Poppins', sans-serif;
    height:100%;
    padding: 20px;
    max-width: 700px; 
    margin: auto;
}

h2 { 
  text-align: center; 
  color:rgb(4, 4, 95);
}


#chatbox { 
  border: 1px solid #ccc; 
  padding: 10px; 
  height: 320px; 
  overflow-y: scroll; 
  margin-bottom: 10px; 

  position: relative; /* l√†m g·ªëc t·ªça ƒë·ªô cho ph·∫ßn t·ª≠ con */
}
.overlay-btn {
  position: absolute;
  top: 10px;      /* kho·∫£ng c√°ch t·ª´ tr√™n xu·ªëng */
  right: 10px;    /* kho·∫£ng c√°ch t·ª´ ph·∫£i sang */
  z-index: 20;    /* ƒë·∫£m b·∫£o n√∫t n·∫±m tr√™n */
  border-color: transparent ;
  background: transparent;
  color:white;
  transition: transform 0.2s ease;
}
.overlay-btn:hover {
  transform: scale(1.5); /* ph√≥ng to gap ruoi */
}

.menu-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}


.menu-group select {
  width: 40%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 8px;
  font-size: 16px;
  background-color: transparent;
}
.button-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%; /* ho·∫∑c ƒë·∫∑t chi·ªÅu r·ªông c·ª• th·ªÉ */
  padding: 10px 0px; /* tu·ª≥ ch·ªânh kho·∫£ng c√°ch l·ªÅ */
}
#mic1_button {
    width: 70px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 70px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#mic2_button {
    width: 70px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 70px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#start_button {
    width: 30px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 30px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    font-size: 16px;
    /*background-image: url("icons/started.png");  ·∫¢nh b√™n trong */
    background-image:  url('icons/start.png'); /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: none; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}


#loa_button {
  padding: 10px 20px;
  font-size: 16px;
  width: 50px;
  height: 50px;
  border: 2px solid #ccc;
  background-image: url("icons/loa.png");
  background-size: cover;
  background-position: center;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.mic1-noi {
  color: rgb(125, 122, 122);
  position: relative;
  top: -4px; /* n√¢ng l√™n 5px */

}
.mic1-dich {
  color: darkgreen;
  font-size: xx-large;
}

.mic2-noi {
  color: #71759f;
  position: relative;
  top: -4px; /* n√¢ng l√™n 5px */

}
.mic2-dich {
  color: darkblue;
  font-size: xx-large;
}
#lang1_select {
  color:rgb(2, 78, 2);
}

#lang2_select {
  text-align: right;       /* CƒÉn n·ªôi dung sang ph·∫£i */
  direction: rtl;          /* ƒê·∫£o h∆∞·ªõng d√≤ng ƒë·ªÉ option hi·ªÉn th·ªã s√°t ph·∫£i */
  color: darkblue;
}
.keyboard-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%  0% 24%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}
.keyboard-group div {
  width: 30%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 0;
  font-size: 24px;
  background-color: transparent;
}
#about{
    color:#b18024;
    font-size: 36px;
}
</style>

</head>
<body>
<h2 ><span id="about">C</span>hat with foreigners with translation</h2>
<h2 >üó£Ô∏è<button id="start_button"></button>üë§</h2>

<div id="chatbox">
  <button class="overlay-btn" onclick="removeAllDivs()">Clear üóå</button>
</div>

<br>
<div class="menu-group">
    <select id="lang1_select" onchange="toggleMenu1()" ></select>
    <select id="lang2_select" onchange="toggleMenu2()" ></select>
</div>

<div class="button-group">
    <button id="mic1_button" >üé§</button>
    <button id="loa_button" ></button>
    <button id="mic2_button" >üéôÔ∏è</button>
</div>

<div class="keyboard-group">
    <div id="keyboard1">‚å®Ô∏è</div>
    <div id="keyboard2">‚å®Ô∏è</div>
</div>
<br><br><br>

<script>
const start_button = document.getElementById("start_button");
const chatbox = document.getElementById("chatbox");
const mic1_button = document.getElementById("mic1_button");
const mic2_button = document.getElementById("mic2_button");  
const loa_button = document.getElementById("loa_button");
const lang1_select =  document.getElementById("lang1_select");
const lang2_select =  document.getElementById("lang2_select");

//list cac langs co 13 langs
//lLangs[n][0] se la ten lang ro rang cua nuoc do
//lLangs[n][1] se la voice
const lLangs = 
[['Chinese',    'zh-TW', 'Ti·∫øng Trung'],
 ['Danish',     'da-DK', 'Ti·∫øng ƒêan M·∫°ch'], 
 ['Dutch',      'nl-NL', 'Ti·∫øng H√† Lan'],
 ['English',    'en-US', 'Ti·∫øng Anh'],
 ['French',     'fr-FR', 'Ti·∫øng Ph√°p'],
 ['German',     'de-DE', 'Ti·∫øng ƒê·ª©c'],
 ['Hebrew',     'he-IL', 'Ti·∫øng Do Th√°i'],
 ['Italy',      'it-IT', 'Ti·∫øng Italy'],
 ['Japanese',   'ja-JP', 'Ti·∫øng Nh·∫≠t'],
 ['Khmer',      'xx-xx', 'Ti·∫øng Khmer'],
 ['Korean',     'ko-KR', 'Ti·∫øng H√†n'],
 ['Lao',        'lo-LA', 'Ti·∫øng L√†o'],
 ['Latin',      'la-LAT','Ti·∫øng La-tinh'],
 ['Portuguese', 'pt-PT', 'Ti·∫øng B·ªì ƒê√†o Nha'],
 ['Rusian',     'ru-RU', 'Ti·∫øng Nga'],
 ['Spanish',    'es-MX', 'Ti·∫øng T√¢y Ban Nha'],
 ['Thai',       'th-TH', 'Ti·∫øng Th√°i'],
 ['Tibetan',    'bo-CN', 'Ti·∫øng T√¢y T·∫°ng'],
 ['Turkish',    'tr-TR', 'Ti·∫øng Th·ªï Nhƒ© K·ª≥'],
 ['Vietnamese', 'vi-VN', 'Ti·∫øng Vi·ªát']]

// alert(lLangs[12][0]); //la Danish
//alert(lLangs[12][1]); //la da-DK
//alert(lLangs[12][1].substring(0, 2)); //la da

//day la list cac lang quoc gia, vd French
const listLangCountry = lLangs.map(pt => pt[0]);

//day la list cac MA lang voice, vd fr-FR
const listLangVoice = lLangs.map(pt => pt[1]);

//day la list cac Tieng theo tieng Viet, vd Tieng ƒêan M·∫°ch, Ti·∫øng L√†o...
const listLangTiengDich = lLangs.map(pt => pt[2]);


var lang1VoiceC=null; //voice tim theo ma, vd 'vi-VN' cua lang1_select 
var lang2VoiceC=null; //voice tim theo ma, vd 'en-US' cua lang2_select
var tiengYcDich='';


function updateMenulang1_select() {
    for (let i = 0; i < listLangCountry.length; i++) {
        let optn = listLangCountry[i];
        let el = document.createElement("option");
        el.textContent = optn;
        el.value = optn;
        lang1_select.appendChild(el);
    }
}
updateMenulang1_select();
lang1_select.selectedIndex = 19; // ch·ªçn option th·ª© 2 (index b·∫Øt ƒë·∫ßu t·ª´ 0)

function updateMenulang2_select() {
    for (let i = 0; i < listLangCountry.length; i++) {
        let optn = listLangCountry[i];
        let el = document.createElement("option");
        el.textContent = optn;
        el.value = optn;
        lang2_select.appendChild(el);
    }
}
updateMenulang2_select();
lang2_select.selectedIndex = 3; // ch·ªçn option th·ª© 2 (index b·∫Øt ƒë·∫ßu t·ª´ 0)

//------------------
function toggleMenu1() {
  let voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    console.warn("Danh s√°ch voices ch∆∞a s·∫µn s√†ng. ƒê·ª£i s·ª± ki·ªán voiceschanged...");
    return;
  }
  //console.log("Available voices:", voices.map(v => v.name + ' (' + v.lang + ')'));
  //console.log('lang2_select.selectedIndex:', lang2_select.selectedIndex);
  //console.log(listLangVoice[lang2_select.selectedIndex]);
  if (listLangVoice[lang1_select.selectedIndex]==='en-US'){
    lang1VoiceC = voices.find(v => v.lang === 'en-US' && (v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Karen') || v.name.includes('Zira')));
    if (lang1VoiceC===undefined){
      lang1VoiceC = voices.find(v => v.lang === listLangVoice[lang1_select.selectedIndex]);
    }    
  }else{
    lang1VoiceC = voices.find(v => v.lang === listLangVoice[lang1_select.selectedIndex]);
  }
  if (lang1VoiceC === undefined) {
    console.log('Kh√¥ng c√≥ voice ph√π h·ª£p');
  } else {
    console.log('Voice ƒë∆∞·ª£c ch·ªçn:', lang1VoiceC.lang);
  }
}

//------------------------
function toggleMenu2() {
  let voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    console.warn("Danh s√°ch voices ch∆∞a s·∫µn s√†ng. ƒê·ª£i s·ª± ki·ªán voiceschanged...");
    return;
  }
  //console.log("Available voices:", voices.map(v => v.name + ' (' + v.lang + ')'));
  //console.log('lang2_select.selectedIndex:', lang2_select.selectedIndex);
  //console.log(listLangVoice[lang2_select.selectedIndex]);
  if (listLangVoice[lang2_select.selectedIndex]==='en-US'){
    lang2VoiceC = voices.find(v => v.lang === 'en-US' && (v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Karen') || v.name.includes('Zira')));
    if (lang2VoiceC===undefined){
      lang2VoiceC = voices.find(v => v.lang === listLangVoice[lang2_select.selectedIndex]);
    }    
  }else{
    lang2VoiceC = voices.find(v => v.lang === listLangVoice[lang2_select.selectedIndex]);
  }
  if (lang2VoiceC === undefined) {
    console.log('Kh√¥ng c√≥ voice ph√π h·ª£p');
  } else {
    console.log('Voice ƒë∆∞·ª£c ch·ªçn:', lang2VoiceC.lang);
  }
}

// ƒê·ª£i s·ª± ki·ªán voiceschanged ƒë·ªÉ g·ªçi toggleMenu1
speechSynthesis.onvoiceschanged = () => {
  toggleMenu1();
  toggleMenu2();
  console.log('lang1VoiceC:',lang1VoiceC);
  console.log('lang2VoiceC:',lang2VoiceC);
};


function addMessage(role, text) {
    text = text.replace(/^"(.*)"$/, '$1');// b·ªè d·∫•u ngo·∫∑c k√©p ·ªü ƒë·∫ßu v√† cu·ªëi n·∫øu c√≥
    const div = document.createElement("div");
    //div.innerHTML = `<span class='${role}'>${text}</span> <br>`;
    //div.innerHTML = `<span class="${role}">${role === "mic1-noi" ? "<br>" : ""} ${text}</span>`;
    if (role.includes('mic1')){
      div.innerHTML = `<span class="${role}">${role.includes('mic1-noi') ? "<br>üü¢" : ""} ${text}</span>`;
    }
    if (role.includes('mic2')){
      div.innerHTML = `<span class="${role}">${role.includes('mic2-noi') ? "<br>üë§" : ""} ${text}</span>`;
    }  

    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}

// H√†m ph√°t √¢m text dich
function speakTextDich(text,langVoice) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    //utterance.voice = langVoice;
    //utterance.lang = langVoice.lang;
    utterance.lang = langVoice.lang
    utterance.onend = () => loa_button.style.backgroundImage = "url('icons/loa.png')";
    speechSynthesis.speak(utterance);
    loa_button.style.backgroundImage = "url('icons/loa-animation.gif')";
  }else{
    console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ speechSynthesis");
  }  


};

// H√†m ƒë·ªÉ d·ªãch 
function dichTextFromTo(textCanDich,fromMadt,toMadt,role){
  //console.log('cac ts:',textCanDich,fromMadt,toMadt,role);
  const inputText = textCanDich;
  let sourceLanguage = fromMadt;
  let targetLanguage = toMadt;

  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200){
      const responseReturned = JSON.parse(this.responseText);
      const translations = responseReturned[0].map((text) => text[0]);
      const textDichRa = translations.join(" ");
      console.log(role,textDichRa);
      //Xu li tiep tuc bang ham addMessage
      if (role==='mic1'){
        addMessage('mic1-dich', textDichRa);
        loa_button.onclick = () => speakTextDich(textDichRa, lang2VoiceC);//lang2VoiceC la global da ton tai va update
        loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n

      }else{
        addMessage('mic2-dich', textDichRa);
        loa_button.onclick = () => speakTextDich(textDichRa, lang1VoiceC);//lang2VoiceC la global da ton tai va update
        loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n

      }
    }
  };
  xhttp.open("GET", url);
  xhttp.send();
}

// Nh·∫≠n gi·ªçng n√≥i t·ª´ mic1
mic1_button.onclick = () => {
    const recognition1 = new webkitSpeechRecognition();
    recognition1.lang = listLangVoice[lang1_select.selectedIndex].substring(0,2);
    recognition1.continuous = false;//
    recognition1.interimResults = false;// Ch·ªâ l·∫•y k·∫øt qu·∫£ cu·ªëi c√πng
    recognition1.onresult = async (event) => {
        const mic1TextNoi = event.results[0][0].transcript;
        console.log("B·∫°n n√≥i:", mic1TextNoi);
        addMessage("mic1-noi", mic1TextNoi);
        recognition1.stop();// D·ª´ng nh·∫≠n gi·ªçng n√≥i khi k·∫øt th√∫c 
        //dat o cho nay thi mic ios moi bien mat
        //alert(vietnameseText);

        // D·ªãch b·∫±ng xttps 
        let fromMa = listLangVoice[lang1_select.selectedIndex].substring(0,2);
        let toMa = listLangVoice[lang2_select.selectedIndex].substring(0,2);
        dichTextFromTo(mic1TextNoi,fromMa,toMa,'mic1')
    };
    recognition1.onerror = (e) => {
        console.error("L·ªói nh·∫≠n gi·ªçng n√≥i:", e.error);
    };
    recognition1.onend = () => {
      mic1_button.style.backgroundImage = "none";
    };
    recognition1.onstart = function() {// ƒëang nh·∫≠n gi·ªçng n√≥i sau khi b·∫•m mic1
      mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')"; 
    };
    recognition1.start();// B·∫Øt ƒë·∫ßu nh·∫≠n gi·ªçng n√≥i
};

// Nh·∫≠n gi·ªçng n√≥i t·ª´ mic2
mic2_button.onclick = () => {
    const recognition2 = new webkitSpeechRecognition();
    recognition2.lang = listLangVoice[lang2_select.selectedIndex].substring(0,2);
    recognition2.continuous = false;//
    recognition2.interimResults = false;// Ch·ªâ l·∫•y k·∫øt qu·∫£ cu·ªëi c√πng

    recognition2.onresult = async (event) => {
        const mic2TextNoi = event.results[0][0].transcript;
        console.log("B·∫°n n√≥i:", mic2TextNoi);
        addMessage("mic2-noi", mic2TextNoi);

        recognition2.stop();// D·ª´ng nh·∫≠n gi·ªçng n√≥i khi k·∫øt th√∫c 
        //dat o cho nay thi mic ios moi bien mat
        //alert(vietnameseText);
        // D·ªãch b·∫±ng xttps 
        let fromMa = listLangVoice[lang2_select.selectedIndex].substring(0,2);
        let toMa = listLangVoice[lang1_select.selectedIndex].substring(0,2);
        dichTextFromTo(mic2TextNoi,fromMa,toMa,'mic2')
    };

    recognition2.onerror = (e) => {
        console.error("L·ªói nh·∫≠n gi·ªçng n√≥i:", e.error);
    };
    recognition2.onend = () => {
      mic2_button.style.backgroundImage = "none";
    };
    recognition2.onstart = function() {// ƒëang nh·∫≠n gi·ªçng n√≥i sau khi b·∫•m mic1
      mic2_button.style.backgroundImage = "url('icons/mic2-animation.gif')"; 
    };

    recognition2.start();// B·∫Øt ƒë·∫ßu nh·∫≠n gi·ªçng n√≥i

  };

start_button.onclick=()=>{
  //--Doan ma nay chi de mo micro trong iphone, lap top ko can
  const recognition = new webkitSpeechRecognition();
  recognition.onresult = e => {
    console.log(e.results[0][0].transcript);
    recognition.stop();
  };  

  recognition.start();
  //--het doan

  //chi de kich hoat loa lan dau, 
  loa_button.onclick = () => speakTextDich("Ready!");
  loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n

  start_button.style.backgroundImage = "url('icons/started.png')";
  start_button.disabled = true;


}

function removeAllDivs() {
  const childDivs = chatbox.querySelectorAll("div");
  childDivs.forEach(div => div.remove());
}


</script>    
</body>
</html>
