<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk With Translation</title>
<style>
/*body { font-family: Times New-Roman, sans-serif; padding: 20px; max-width: 700px; margin: auto; }*/

body {
    background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
    color: #fff;
    font: 1rem/1 'Poppins', sans-serif;
    height:100%;
    padding: 20px;
    max-width: 700px; 
    margin: auto;
}

h2 { text-align: center; color:darkblue}
#chatbox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }

.menu-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}


.menu-group select {
  width: 30%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 8px;
  font-size: 16px;
  background-color: transparent;
}
.button-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%; /* ho·∫∑c ƒë·∫∑t chi·ªÅu r·ªông c·ª• th·ªÉ */
  padding: 10px 0px; /* tu·ª≥ ch·ªânh kho·∫£ng c√°ch l·ªÅ */
}
#mic1_button {
  padding: 10px 20px;
  font-size: 14px;
  width: 60px;
  height: 60px;
  border: 2px solid #ccc;
  border-radius: 50%;
  }
#mic2_button {
  padding: 10px 20px;
  font-size: 14px;
  text-align: center;
  width: 60px;
  height: 60px;
  border: 2px solid #ccc;
  border-radius: 50%;
}


#loa_button {
  padding: 10px 20px;
  font-size: 16px;
  width: 60px;
  height: 60px;
  border: 2px solid #ccc;
}

</style>
</head>
<body>
<h2 >üó£Ô∏èSpeaking Different Languagesüë§</h2>

<div id="chatbox"></div>

<div class="menu-group">
    <select id="lang-left" onclick="toggleMenuL()" ></select>
    <select id="lang-right" onclick="toggleMenuR()" ></select>
</div>

<div class="button-group">
    <button id="mic1_button" onclick="toggleMic1()" >üé§</button>
    <button id="loa_button" onclick="repeatText()" ></button>
    <button id="mic2_button" onclick="toggleMic2()" >üéôÔ∏è</button>
</div>

<script>
let langChatN = 0;
let langChatSpeak = 'vi-VN';
let langChatText = 'vi';


const chatbox = document.getElementById("chatbox");
const textInput = document.getElementById("textInput");

//chatbox.innerHTML += `<div class="user" style="text-align:right;"><b>‚ùî</b> ${pair.user}</div>`;
//chatbox.innerHTML += `<div class="bot" style="text-align:left;"><b>üí¨</b> ${pair.bot}</div>`;

function addMessage(role, text) {
    const div = document.createElement("div");
    div.innerHTML = `<span class="${role}">${role === "user" ? "<br>‚ùî" : "üí¨"} ${text}</span>`;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}

async function sendToGPT(message) {
    const res = await fetch("https://your-server.com/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
    });
    const data = await res.json();
    return data.reply;
}

async function sendText() {
    const msg = textInput.value.trim();
    if (!msg) return;
    addMessage("user", msg);
    textInput.value = "";
    const reply = await sendToGPT(msg);
    addMessage("gpt", reply);
    speak(reply);
}

// SPEECH TO TEXT (Voice Input)
let recognition;
let listening = false;

function toggleMic1() {
    if (!listening) {
        startRecognition();
        startVoiceChat();
    } else {
        stopRecognition();
    }
}

function startRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechRecognition.");
        return;
    }
    recognition = new webkitSpeechRecognition();
    recognition.lang = langChatSpeak;
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = async (event) => {
    const transcript = event.results[0][0].transcript;
    addMessage("user", transcript);
    const reply = await sendToGPT(transcript);
    addMessage("gpt", reply);
    speak(reply);
    };

    recognition.onstart = () => listening = true;
    recognition.onend = () => listening = false;

    recognition.start();
}

function stopRecognition() {
    if (recognition) recognition.stop();
}

// TEXT TO SPEECH
function speak(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langChatSpeak;
    speechSynthesis.speak(utter);
}

//DN ham sendToGPT
async function sendToGPT(prompt) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }]
        }),
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;
    return reply;
}


//DN ham handleUserSpeech
async function handleUserSpeech(text) {
    log(`<b>B·∫°n:</b> ${text}`);

    const reply = await sendToGPT(text);
    log(`<b>GPT:</b> ${reply}`);

    return new Promise((resolve) => {
        const utter = new SpeechSynthesisUtterance(reply);
        utter.lang = langChatSpeak;
        utter.onend = () => resolve();
        speechSynthesis.speak(utter);
    });
}

//DN ham recordOnce
function recordOnce() {
    return new Promise((resolve, reject) => {
        recognition.start();

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            recognition.stop();
            resolve(transcript);
        };

        recognition.onerror = (e) => {
            recognition.stop();
            reject(e);
        };
    });
}

// khi nhap mic thi thuc thi ham sau:
async function startVoiceChat() {
    log("‚è≥ ƒêang l·∫Øng nghe b·∫°n...");
    while (true) {
        try {
            const userSpeech = await recordOnce();
            await handleUserSpeech(userSpeech);
        } catch (err) {
            console.error("L·ªói:", err);
            break;
        }
    }
}
//DN ham tieng_chon_chat
function tieng_chon_chat(){
    langChatN += 1; 
    if (langChatN % 7 === 1) {
        langChatSpeak = 'en-US';
        langChatText = 'en';
        document.getElementById("langChonText").innerText="English";
    } else if (langChatN % 7 === 2) {
        langChatSpeak = 'fr-FR';
        langChatText = 'fr';
        document.getElementById("langChonText").innerText="French";
    } else if (langChatN % 7 === 3) {
        langChatSpeak = 'da-DK';
        langChatText = 'da';
        document.getElementById("langChonText").innerText="Denmark";
    } else if (langChatN % 7 === 4) {
        langChatSpeak = 'nl-NL';
        langChatText = 'nl';
        document.getElementById("langChonText").innerText="Nederlands";
    } else if (langChatN % 7 === 5) {
        langChatSpeak = 'de-DE';
        langChatText = 'de';
        document.getElementById("langChonText").innerText="German";
    } else if (langChatN % 7 === 6) {
        langChatSpeak = 'zh-TW';
        langChatText = 'zh';
        document.getElementById("langChonText").innerText="Taiwan";
    } else if (langChatN % 7 === 0) {
        langChatSpeak = 'vi-VN';
        langChatText = 'vi';
        document.getElementById("langChonText").innerText="Vietnamese";
    }; 
}
</script>
</body>
</html>
