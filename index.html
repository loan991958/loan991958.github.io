<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk With Foreigners</title>
<style>
body {
    background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
    color: #fff;
    font: 1rem/1 'Poppins', sans-serif;
    height:100%;
    padding: 20px;
    max-width: 700px; 
    margin: auto;
}

h2 { text-align: center; color:darkblue}
#chatbox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }

.menu-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}


.menu-group select {
  width: 30%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 8px;
  font-size: 16px;
  background-color: transparent;
}
.button-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%; /* ho·∫∑c ƒë·∫∑t chi·ªÅu r·ªông c·ª• th·ªÉ */
  padding: 10px 0px; /* tu·ª≥ ch·ªânh kho·∫£ng c√°ch l·ªÅ */
}
#mic1_button {
    width: 50px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 50px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#mic2_button {
    width: 50px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 50px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}


#loa_button {
  padding: 10px 20px;
  font-size: 16px;
  width: 50px;
  height: 50px;
  border: 2px solid #ccc;
  background-image: url("icons/loa.png");
  background-size: cover;
  background-position: center;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}

</style>
</head>
<body>
<h2 >üó£Ô∏èTalk With Foreignersüë§</h2>

<div id="chatbox"></div>

<div class="menu-group">
    <select id="lang-left" onclick="toggleMenuL()" ></select>
    <select id="lang-right" onclick="toggleMenuR()" ></select>
</div>

<div class="button-group">
    <button id="mic1_button" onclick="toggleMic1()" >üé§</button>
    <button id="loa_button" onclick="repeatText()" ></button>
    <button id="mic2_button" onclick="toggleMic2()" >üéôÔ∏è</button>
</div>
<script>
//===Tien them
const mic1_button = document.getElementById("mic1_button");
const mic2_button = document.getElementById("mic2_button");
const loa_button = document.getElementById("loa_button");

//Giai ma-bmat
const dnaToBinaryMap = {
'A': '00',
'C': '01',
'G': '10',
'T': '11'
};

function dnaToBinarySequence(dna) {
    return dna
    .split('')
    .map(base => dnaToBinaryMap[base] || '')
    .join('');
}

function binaryToText(binary) {
    let text = '';
    for (let i = 0; i < binary.length; i += 8) {
        const byte = binary.slice(i, i + 8);
        text += String.fromCharCode(parseInt(byte, 2));
    }
    return text;
}

function decodeDNA(textkhoaapi) {
    const binary = dnaToBinarySequence(textkhoaapi);
    const text = binaryToText(binary);
    return text;
}
//End Giai ma-bmat

let langChatN = 0;
let langChatSpeak1 = 'vi-VN';
let langChatSpeak2 = 'en-US';
let langChatText = 'vi';

const textkhoaapi = "CTATCGGTAGTCCTAACTAGCGTTCGGGAGTCCGCCCTAACCGACTCTCGGGCATACAACCGCCCAGTCCAACATACAAGCTCCCCCACACGCATCCTCGCGGGCACACGTCCGCACCACCAACCGGACACACCCGCGAGCGGACAGTCGATCCATCCGGCAGGATCGATAACTGACGGTCACACAGCATCACGGCCACGATCAATACATGCCTCCCTCGCGGACCGACAATATCTCACTCCGGATCTCGGGCCATATCTCAATCAGACGTAATGAAGTCCATTCAATCGCCCGTCCATCATAGATGCATATCAGTCTCACCCCATCCCCCAATATCAAGCGTACGAGCGGTCACGCAGGCAGGATACATCACGGCATCACCACCAACCCCTCAAGCCGCCGGCCAGGCCACCGAGCCAACATCCATGCAAGCATTCATCCTCACTATCTAACTAAATGACCACCATAAGTCAGTCCGTCCCCGCGAGCACTATAGCTCCCGGCCGCTATAGCGTTCTACATCAATCACCGCCACTCTCACGGGCCCTATGCCCCACACGCGAGATATCACACGCACCACCTCCCAGCCTAGCAGTCCGCCGTCATCTCGGTCATGCTCGCTCGCCCACGTGCCCCCTACCAGTCGTTCCCCCAAC";
//===Tien them

const apiKey = decodeDNA(textkhoaapi)

const chatbox = document.getElementById("chatbox");
const textInput = document.getElementById("textInput");

//chatbox.innerHTML += `<div class="user" style="text-align:right;"><b>‚ùî</b> ${pair.user}</div>`;
//chatbox.innerHTML += `<div class="bot" style="text-align:left;"><b>üí¨</b> ${pair.bot}</div>`;

function addMessage(role, text) {
    const div = document.createElement("div");
    div.innerHTML = `<span class="${role}">${role === "user" ? "<br>‚ùî" : "üí¨"} ${text}</span>`;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}
const hauto = "D·ªãch c√¢u tr√™n ƒë√¢y sang ti·∫øng Anh m√† kh√¥ng c·∫ßn gi·∫£i th√≠ch." 

async function sendToGPT(message) {
    const res = await fetch("https://your-server.com/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
    });
    const data = await res.json();
    return data.reply;
}

async function sendText() {
    const msg = textInput.value.trim();
    if (!msg) return;
    msg = msg + hauto;
    alert(msg);
    addMessage("user", msg);
    textInput.value = "";
    const reply = await sendToGPT(msg);
    addMessage("gpt", reply);
    speak(reply);
}

// SPEECH TO TEXT (Voice Input)
let recognition1;
let listening1 = false;

function toggleMic1() {
    if (!listening1) {//neu chua lang nghe thi bat dau lang nghe
        mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')"; // Set the background image
        startRecognition1();
        startVoiceChat1();
    } else {//neu dang lang nghe thi dung lang nghe
        stopRecognition1();
        mic1_button.style.backgroundImage = "url('')"; // Set the background image
    }
}

function startRecognition1() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechRecognition.");
        return;
    }
    mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')";
    recognition1 = new webkitSpeechRecognition();
    recognition1.lang = langChatSpeak1;
    recognition1.continuous = false;
    recognition1.interimResults = false;

    recognition1.onresult = async (event) => {
    const transcript = event.results[0][0].transcript;
    

    addMessage("user", transcript);//them tin nhan vao chatbox,xem nhu yeu cau cua user
    const reply = await sendToGPT(transcript + hauto);//tra ve hoi dap cua GPT
    addMessage("gpt", reply);//them tin nhan vao chatbox,xem nhu tra loi cua gpt
    mic1_button.style.backgroundImage = "url('')";//cho mic1 thoi nhap nhay
    loa_button.style.backgroundImage = "url('icons/loa-animation.gif')";//cho loa nhap nhay
    
    speak(reply);//doc toan bo cau tra loi

    };

    recognition1.onstart = () => listening1 = true;
    recognition1.onend = () => listening1 = false;

    recognition1.start();
}

function stopRecognition1() {
    if (recognition1) {
        recognition1.stop();
        listening1 = false;
        mic1_button.style.backgroundImage = "url('')"; // Set the background image}
    }
}

// TEXT TO SPEECH
function speak(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langChatSpeak2;
    utter.onend = () => loa_button.style.backgroundImage = "url('icons/loa.png')";
    speechSynthesis.speak(utter);
}

//DN ham sendToGPT
async function sendToGPT(prompt) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }]
        }),
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;
    return reply;
}


//DN ham handleUserSpeech
async function handleUserSpeech(text) {
    log(`<b>B·∫°n:</b> ${text}`);

    const reply = await sendToGPT(text);
    log(`<b>GPT:</b> ${reply}`);

    return new Promise((resolve) => {
        const utter = new SpeechSynthesisUtterance(reply);
        utter.lang = langChatSpeak1;
        utter.onend = () => resolve();
        speechSynthesis.speak(utter);
    });
}

//DN ham recordOnce
function recordOnce() {
    return new Promise((resolve, reject) => {
        recognition1.start();

        recognition1.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            recognition1.stop();
            resolve(transcript);
        };

        recognition1.onerror = (e) => {
            recognition1.stop();
            mic1_button.style.backgroundImage = "url('')"; // Set the background image
            reject(e);
        };
    });
}

// khi nhap mic thi thuc thi ham sau:
async function startVoiceChat1() {

    log("‚è≥ ƒêang l·∫Øng nghe b·∫°n...");
    while (true) {
        try {
            const userSpeech = await recordOnce();
            await handleUserSpeech(userSpeech);
        } catch (err) {
            console.error("L·ªói:", err);
            break;
        }
    }
}
//DN ham tieng_chon_chat
function tieng_chon_chat(){
    langChatN += 1; 
    if (langChatN % 7 === 1) {
        langChatSpeak = 'en-US';
        langChatText = 'en';
        document.getElementById("langChonText").innerText="English";
    } else if (langChatN % 7 === 2) {
        langChatSpeak = 'fr-FR';
        langChatText = 'fr';
        document.getElementById("langChonText").innerText="French";
    } else if (langChatN % 7 === 3) {
        langChatSpeak = 'da-DK';
        langChatText = 'da';
        document.getElementById("langChonText").innerText="Denmark";
    } else if (langChatN % 7 === 4) {
        langChatSpeak = 'nl-NL';
        langChatText = 'nl';
        document.getElementById("langChonText").innerText="Nederlands";
    } else if (langChatN % 7 === 5) {
        langChatSpeak = 'de-DE';
        langChatText = 'de';
        document.getElementById("langChonText").innerText="German";
    } else if (langChatN % 7 === 6) {
        langChatSpeak = 'zh-TW';
        langChatText = 'zh';
        document.getElementById("langChonText").innerText="Taiwan";
    } else if (langChatN % 7 === 0) {
        langChatSpeak = 'vi-VN';
        langChatText = 'vi';
        document.getElementById("langChonText").innerText="Vietnamese";
    }; 
}
</script>
</body>
</html>
