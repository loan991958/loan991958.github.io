<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
<style>
body {
    background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
    color: #fff;
    font: 1rem/1 'Poppins', sans-serif;
    height:100%;
    padding: 20px;
    max-width: 700px; 
    margin: auto;
}

h2 { text-align: center; color:darkblue}
#chatbox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }

.menu-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}


.menu-group select {
  width: 30%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 8px;
  font-size: 16px;
  background-color: transparent;
}
.button-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%; /* ho·∫∑c ƒë·∫∑t chi·ªÅu r·ªông c·ª• th·ªÉ */
  padding: 10px 0px; /* tu·ª≥ ch·ªânh kho·∫£ng c√°ch l·ªÅ */
}
#mic1_button {
    width: 60px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 60px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#mic2_button {
    width: 60px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 60px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}


#loa_button {
  padding: 10px 20px;
  font-size: 16px;
  width: 50px;
  height: 50px;
  border: 2px solid #ccc;
  background-image: url("icons/loa.png");
  background-size: cover;
  background-position: center;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}

</style>

</head>
<body>
<h2 >üó£Ô∏èTalk With Foreignersüë§</h2>

<div id="chatbox"></div>

<div class="menu-group">
    <select id="lang-left" onclick="toggleMenuL()" ></select>
    <select id="lang-right" onclick="toggleMenuR()" ></select>
</div>

<div class="button-group">
    <button id="mic1_button" onclick="toggleMic1()" >üé§</button>
    <button id="loa_button" onclick="repeatText()" ></button>
    <button id="mic2_button" onclick="toggleMic2()" >üéôÔ∏è</button>
</div>




<script>
//--menu unit
let listUrlYt = ["https://youtu.be/sk=proj=epXwjLAeKPLBuTFMvjDmdQAhDVbhKcSZJ60xkDI4iF419uvhXC7GZ7jS7CHl8=OCemM293KtU5T3BlbkFJJ14i4QAWBYiJQbPMNBOMtspp8QL==mVbG2uig2oq44YGtjW9TFb3DdQuIrKYm7kNvvTnUqKoUA"];
///GFG_FunBo();
function maHoaLaiAK(){
    let ch = listUrlYt[listUrlYt.length - 1].split("be/")[1].replaceAll("=","-");
    //console.log(ch);
    return ch;
}
var apiKey=maHoaLaiAK();

//--chatgpt-----------------------------
async function sendMessage(transcript) {
    let userInput = transcript;
    //alert(userInput);
    if (!userInput) return;
    //let chatbox = document.getElementById("chatbox");
    //chatbox.innerHTML += `<p><strong>B·∫°n:</strong> ${userInput}</p>`;
  
    // G·ª≠i tin nh·∫Øn ƒë·∫øn OpenAI API
    let response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: userInput }]
      })
    });
  
    let data = await response.json();
    //console.log(data);
    let reply = data.choices[0].message.content;
  
    if (transcript.search("gi·∫£i th√≠ch t·ª´ ng·ªØ ti·∫øng Anh sau ƒë√¢y v√† ƒë·ªãnh d·∫°ng k·∫øt qu·∫£ b·∫±ng Markdown")>0){
      //console.log(reply);
      HienThiTrongSwal(reply);
    }else{
      resultsdichEl.innerText = reply;
  
      let textCanDich = resultsdichEl.innerText.trim() ;
      let ptchua = resultsdichViaEl;
      if (langNoi==='en-US'){
        dichRaVi(textCanDich,ptchua);
      }else{
        dichRaEn(textCanDich,ptchua);
  
      }  
    
    speakText(resultsdichEl.innerText);
  }
  
  }
  
  function reSpeak(text){
  
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        //listen_imgEl.src = 'icons/bot.png';
        loa.style.backgroundImage = "url('icons/loa.png')"; // Set the background image
        return;
    }
  
    window.speechSynthesis.cancel();
  
    const utterance = new SpeechSynthesisUtterance(text);
    const detectedLang = 'en-US'; //detectLanguage(text);
    utterance.lang = detectedLang; // 'vi-VN' ho·∫∑c 'en-US'

    loa_button.onclick = () => {
        utterance.onend = () => loa_button.style.backgroundImage = "url('icons/loa.png')";
        speechSynthesis.speak(utterance);
        loa_button.style.backgroundImage = "url('icons/loa-animation.gif')"; // Set the background image
    };
}

function addMessage(role, text) {
    const div = document.createElement("div");
    div.innerHTML = `<span class="${role}">${role === "user" ? "<br>‚ùî" : "üí¨"} ${text}</span>`;
    chatbox.appendChild(div);
    //Neu role === "gpt"  thi doc toan bo cau tra loi o day 
    if (role === "gpt") {
        mic1_button.style.backgroundImage = "url('')";//cho mic1 thoi nhap nhay
        loa_button.style.backgroundImage = "url('icons/loa-animation.gif')";//cho loa nhap nhay

        reSpeak(text);
    }
    chatbox.scrollTop = chatbox.scrollHeight;
}
const hauto = "D·ªãch c√¢u tr√™n ƒë√¢y sang ti·∫øng Anh m√† kh√¥ng c·∫ßn gi·∫£i th√≠ch." 

async function sendToGPT(prompt) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }]
        }),
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;
    return reply;
}

async function sendText() {
    const msg = textInput.value.trim();
    if (!msg) return;
    msg = msg + hauto;
    alert(msg);
    addMessage("user", msg);
    textInput.value = "";
    const reply = await sendToGPT(msg);
    addMessage("gpt", reply);
    //speak(reply);
}

function startRecognition1() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechRecognition.");
        return;
    }
    mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')";
    recognition1 = new webkitSpeechRecognition();
    recognition1.lang = 'vi-VN';
    recognition1.continuous = false;
    recognition1.interimResults = false;

    recognition1.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage("user", transcript);//them tin nhan vao chatbox,xem nhu yeu cau cua user
        const reply = await sendToGPT(transcript + hauto);//tra ve hoi dap cua GPT
        addMessage("gpt", reply);//them tin nhan vao chatbox,xem nhu tra loi cua gpt
        //reSpeak(reply);//doc toan bo cau tra loi
    };

    recognition1.onstart = () => listening1 = true;
    recognition1.onend = () => listening1 = false;

    recognition1.start();
}
function recordOnce() {
    return new Promise((resolve, reject) => {
        recognition1.start();

        recognition1.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            recognition1.stop();
            resolve(transcript);
        };

        recognition1.onerror = (e) => {
            recognition1.stop();
            mic1_button.style.backgroundImage = "url('')"; // Set the background image
            reject(e);
        };
    });
}
async function handleUserSpeech(text) {
    log(`<b>B·∫°n:</b> ${text}`);

    const reply = await sendToGPT(text);
    log(`<b>GPT:</b> ${reply}`);

    //return new Promise((resolve) => {
    //    const utter = new SpeechSynthesisUtterance(reply);
    //    utter.lang = langChatSpeak1;
    //    utter.onend = () => resolve();
    //    speechSynthesis.speak(utter);
    //});
}

async function startVoiceChat1() {
    log("‚è≥ ƒêang l·∫Øng nghe b·∫°n...");
    while (true) {
        try {
            const userSpeech = await recordOnce();//cho phep nguoi dung noi 1 lan,ghi vao bien 
            await handleUserSpeech(userSpeech);//gui van ban do den GPT de tra loi
        } catch (err) {
            console.error("L·ªói:", err);
            break;
        }
    }
}

function stopRecognition1() {
    if (recognition1) {
        recognition1.stop();
        listening1 = false;
        mic1_button.style.backgroundImage = "url('')"; // Set the background image}
    }
}

function toggleMic1() {
    if (!listening1) {//neu chua lang nghe thi bat dau lang nghe
        mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')"; // Set the background image
        startRecognition1();
        startVoiceChat1();
    } else {//neu dang lang nghe thi dung lang nghe
        stopRecognition1();
        mic1_button.style.backgroundImage = "url('')"; // Set the background image
    }
}

//=====Main=================
let mic1_button = document.getElementById("mic1_button");
let loa_button = document.getElementById("loa_button");
let mic2_button = document.getElementById("mic2_button");
let recognition1;
let listening1 = false;

mic1_button.onclick = toggleMic1;



</script>    
</body>
</html>