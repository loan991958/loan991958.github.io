<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Import SweetAlert2 -->
    <title>Chat in multiple languages</title>
<style>
body {
    background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
    color: #fff;
    font: 1rem/1 'Poppins', sans-serif;
    height:100%;
    padding: 20px;
    max-width: 700px; 
    margin: auto;
}

h2 { 
  text-align: center; 
  color:darkgreen;
}
#chatbox { 

  border: 1px solid #ccc; 
  padding: 10px; 
  height: 250px; 
  overflow-y: scroll; 
  margin-bottom: 10px; 
  transition: opacity 0.3s ease;
  position:relative ; /*neu absolue thi chatbox se co lai khi ko co text*/  
  
}
.overlay-btn, .hidetext-btn, .copytext-btn{
  border-color: transparent ;
  background: transparent;
  color:white;
  transition: transform 0.2s ease;
}
.overlay-btn:hover, .hidetext-btn:hover, .copytext-btn:hover {
  transform: scale(1.5); /* ph√≥ng to gap ruoi */
}
.menu-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
}
.menu-group select {
  width: 42%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 8px;
  font-size: 16px;
  background-color: transparent;
}
.button-group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%; /* ho·∫∑c ƒë·∫∑t chi·ªÅu r·ªông c·ª• th·ªÉ */
  padding: 10px 0px; /* tu·ª≥ ch·ªânh kho·∫£ng c√°ch l·ªÅ */
}
#mic1_button {
    width: 70px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 70px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#mic2_button {
    width: 70px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 70px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    /*background-image: url("icons/mic1-animation.gif");  ·∫¢nh b√™n trong */
    background-image:  "url('')"; /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    border: 3px solid #333; /* Vi·ªÅn */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#start_button {
    width: 40px; /* K√≠ch th∆∞·ªõc n√∫t */
    height: 40px;
    border-radius: 50%; /* L√†m cho n√∫t tr√≤n */
    font-size: 16px;
    /*background-image: url("icons/started.png");  ·∫¢nh b√™n trong */
    background-image:  url('icons/start.png'); /* ·∫¢nh b√™n trong */
    background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
    background-position: center;
    background-color: darkolivegreen;
    border: 1px solid lightgreen; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* ƒê·ªï b√≥ng nh·∫π */
    cursor: pointer;
    align-items: center;
    justify-content: center;
}
#loa_button {
  padding: 10px 20px;
  font-size: 16px;
  width: 50px;
  height: 50px;
  border: 2px solid #ccc;
  background-image: url("icons/loa.png");
  background-size: cover;
  background-position: center;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}
.mic1-noi {
  color: rgb(125, 122, 122);
  position: relative;
  top: -4px; /* n√¢ng l√™n 5px */
  font-size:x-large;
}
.mic1-dich {
  color: darkgreen;
  font-size: x-large;
  /*font-size:x-large;*/
}
.mic2-noi {
  color: #71759f;
  position: relative;
  top: -4px; /* n√¢ng l√™n 5px */
  font-size:x-large;
}
.mic2-dich {
  color: darkblue;
  font-size: x-large;
  /*font-weight: bold;*/
}
#lang1_select {
  color:rgb(2, 78, 2);
  font-weight: bolder;
}

#lang2_select {
  text-align: right;       /* CƒÉn n·ªôi dung sang ph·∫£i */
  direction: rtl;          /* ƒê·∫£o h∆∞·ªõng d√≤ng ƒë·ªÉ option hi·ªÉn th·ªã s√°t ph·∫£i */
  color: darkblue;
  font-weight:bolder;
}
.keyboard-group {
  display: flex;
  justify-content: space-between;
  padding: 0 10%  0% 24%; /* c√°ch bi√™n tr√°i v√† ph·∫£i 20px */
  width: 100%;
  box-sizing: border-box;
  
}
.keyboard-group div {
  width: 30%; /* ho·∫∑c tu·ª≥ ch·ªânh theo nhu c·∫ßu */
  padding: 0;
  font-size: 24px;
  background-color: transparent;
}
#about{
    color:#b18024;
    font-size: 36px;
}
#banphim1,#banphim2 {
  background-color: transparent;
  border: none;
  font-size: 30px;
}
.mark1{
  /*background-color: #ffff99;  V√†ng nh·∫°t */
  background-color: #ccffcc;  /*Xanh mint Nh·∫π nh√†ng, d·ªãu m·∫Øt */
  color: inherit;            /* Gi·ªØ m√†u ch·ªØ g·ªëc */
 /*luu de tkhao: background-color: #ffff99; V√†ng nh·∫°t, r·∫•t ph·ªï bi·∫øn, d·ªÖ ƒë·ªçc*/

}

.mark2{
 background-color: #cce5ff; /*  Xanh d∆∞∆°ng nh·∫°t, t∆∞∆°i s√°ng, kh√¥ng l√≥a */
  color: inherit;            /* Gi·ªØ m√†u ch·ªØ g·ªëc */
}
#box1_ghi{
  border: 1px solid #ccc; 
  font-size:24px;
  width:100%;
  height: 300px; 
  overflow-y: scroll; 
  padding-left: 10px;  
  text-align: left; 
  direction: ltr;
} 
#box2_ghi{
  border: 1px solid #ccc; 
  font-size:24px;
  width:100%;
  height: 300px; 
  overflow-y: scroll; 
  
  padding-left: 10px;  
  text-align: left; 
  direction: ltr;
} 
#batTbChatGpt{
  color:#42300d;
  text-align: center;
}
#copiedLabel {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #eee;
  color: #333;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
  white-space: nowrap;
}
</style>

</head>
<body>
<h2 ><span id="about">C</span>hat in multiple languages</h2>
<h2 >üó£Ô∏è<button id="start_button">üîí</button>üë§</h2>

<div class="button-group">
  <button class="hidetext-btn" onclick="anHienDivsInChat()">üóå Hide/Show</button>

  <div style="position: relative; display: inline-block;">
    <div id="copiedLabel" style="display: none;">Copied</div>
    <button class="copytext-btn" onclick="copyText()">Copy üóå &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</button>
  </div>

  <button class="overlay-btn" onclick="removeAllDivs()">Clear üóå</button>
</div>

  <div id="chatbox" aria-hidden="false"></div>

<br>
<div class="menu-group">
    <select id="lang1_select" onchange="toggleMenu1(this.index)" ></select>
    <select id="lang2_select" onchange="toggleMenu2(this.index)" ></select>
</div>

<div class="button-group">
    <button id="mic1_button" >üé§</button>
    <button id="loa_button" ></button>
    <button id="mic2_button" >üéôÔ∏è</button>
</div>

<div class="keyboard-group">
    <div><button id='banphim1' onclick="chatBoxKb1()">‚å®Ô∏è</button></div>
    <div><button id='banphim2' onclick="chatBoxKb2()">‚å®Ô∏è</button></div>
</div>
<h3 id="batTbChatGpt"></h3>
<br><br>

<script>
const start_button = document.getElementById("start_button");
const chatbox = document.getElementById("chatbox");
const chatboxcha = document.getElementById("chatboxcha");

const mic1_button = document.getElementById("mic1_button");
const mic2_button = document.getElementById("mic2_button");  
const loa_button = document.getElementById("loa_button");
const lang1_select =  document.getElementById("lang1_select");
const lang2_select =  document.getElementById("lang2_select");
const banphim1 =  document.getElementById("banphim1");
const banphim2 =  document.getElementById("banphim2");
const batTbChatGpt =  document.getElementById("batTbChatGpt");

mic1_button.disabled = true;
mic2_button.disabled = true;   
banphim1.disabled = true;
banphim2.disabled = true;

//list cac langs co 13 langs
//lLangs[n][0] se la ten lang ro rang cua nuoc do
//lLangs[n][1] se la voice
const lLangs = 
[['Chinese',    'zh-TW', 'Ti·∫øng Trung'],
 ['Danish',     'da-DK', 'Ti·∫øng ƒêan M·∫°ch'], 
 ['Dutch',      'nl-NL', 'Ti·∫øng H√† Lan'],
 ['English',    'en-US', 'Ti·∫øng Anh'],
 ['French',     'fr-FR', 'Ti·∫øng Ph√°p'],
 ['German',     'de-DE', 'Ti·∫øng ƒê·ª©c'],
 ['Hebrew',     'he-IL', 'Ti·∫øng Do Th√°i'],
 ['Italy',      'it-IT', 'Ti·∫øng Italy'],
 ['Japanese',   'ja-JP', 'Ti·∫øng Nh·∫≠t'],
 ['Korean',     'ko-KR', 'Ti·∫øng H√†n'],
 ['Latin',      'la-LAT','Ti·∫øng La-tinh'],
 ['Portuguese', 'pt-PT', 'Ti·∫øng B·ªì ƒê√†o Nha'],
 ['Rusian',     'ru-RU', 'Ti·∫øng Nga'],
 ['Spanish',    'es-MX', 'Ti·∫øng T√¢y Ban Nha'],
 ['Thai',       'th-TH', 'Ti·∫øng Th√°i'],
 ['Turkish',    'tr-TR', 'Ti·∫øng Th·ªï Nhƒ© K·ª≥'],
 ['Vietnamese', 'vi-VN', 'Ti·∫øng Vi·ªát']]

// alert(lLangs[12][0]); //la Danish
//alert(lLangs[12][1]); //la da-DK
//alert(lLangs[12][1].substring(0, 2)); //la da

//day la list cac lang quoc gia, vd French
const listLangCountry = lLangs.map(pt => pt[0]);

//day la list cac MA lang voice, vd fr-FR
const listLangVoice = lLangs.map(pt => pt[1]);

//day la list cac Tieng theo tieng Viet, vd Tieng ƒêan M·∫°ch, Ti·∫øng L√†o...
const listLangTiengDich = lLangs.map(pt => pt[2]);


let lang1VoiceC=null; //voice tim theo ma, vd 'vi-VN' cua lang1_select 
let lang2VoiceC=null; //voice tim theo ma, vd 'en-US' cua lang2_select
var tiengYcDich='';
let mic1TextDich='';
let mic2TextDich='';
let indexSelect1Update=0;
let indexSelect2Update=0;
let daBatChatGpt=false;
var demAnHienClick=0;

function updateMenulang1_select() {
    for (let i = 0; i < listLangCountry.length; i++) {
        let optn = listLangCountry[i];
        let el = document.createElement("option");
        el.textContent = optn;
        el.value = optn;
        lang1_select.appendChild(el);
    }
}
updateMenulang1_select();
// Khi trang t·∫£i, ƒë·ªçc l·ª±a ch·ªçn ƒë√£ l∆∞u
const savedChoice1 = localStorage.getItem("lastSelected1");
if (savedChoice1) {
    lang1_select.selectedIndex = savedChoice1;
} else {
    lang1_select.selectedIndex = 16; // m·∫∑c ƒë·ªãnh l√† l·ª±a ch·ªçn 3
}
indexSelect1Update = lang1_select.selectedIndex;


function updateMenulang2_select() {
    for (let i = 0; i < listLangCountry.length; i++) {
        let optn = listLangCountry[i];
        let el = document.createElement("option");
        el.textContent = optn;
        el.value = optn;
        lang2_select.appendChild(el);
    }
}
updateMenulang2_select();
const savedChoice2 = localStorage.getItem("lastSelected2");
if (savedChoice2) {
    lang2_select.selectedIndex = savedChoice2;
} else {
    lang2_select.selectedIndex = 3; // m·∫∑c ƒë·ªãnh l√† l·ª±a ch·ªçn 3
}
indexSelect2Update = lang2_select.selectedIndex;


//------------------
function toggleMenu1() {
  //cap nhat moi lan thay doi
  indexSelect1Update = lang1_select.selectedIndex;
  let voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    console.warn("Danh s√°ch voices ch∆∞a s·∫µn s√†ng. ƒê·ª£i s·ª± ki·ªán voiceschanged...");
    return;
  }
  if (listLangVoice[indexSelect1Update]==='en-US'){
    lang1VoiceC = voices.find(v => v.lang === 'en-US' && (v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Karen') || v.name.includes('Zira')));
    if (lang1VoiceC===undefined){
      lang1VoiceC = voices.find(v => v.lang === listLangVoice[indexSelect1Update]);
    }    
  }else{
    lang1VoiceC = voices.find(v => v.lang === listLangVoice[indexSelect1Update]);
  }
  if (lang1VoiceC === undefined) {
    console.log('Kh√¥ng c√≥ voice ph√π h·ª£p');
  } else {
    console.log('Voice ƒë∆∞·ª£c ch·ªçn:', lang1VoiceC.lang);
  }
  checkChatGpt();

}

//------------------------
function toggleMenu2() {
  //cap nhat moi lan thay doi
  indexSelect2Update = lang2_select.selectedIndex;
  let voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    console.warn("Danh s√°ch voices ch∆∞a s·∫µn s√†ng. ƒê·ª£i s·ª± ki·ªán voiceschanged...");
    return;
  }
  if (listLangVoice[indexSelect2Update]==='en-US'){
    lang2VoiceC = voices.find(v => v.lang === 'en-US' && (v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Karen') || v.name.includes('Zira')));
    if (lang2VoiceC===undefined){
      lang2VoiceC = voices.find(v => v.lang === listLangVoice[indexSelect2Update]);
    }    
  }else{
    lang2VoiceC = voices.find(v => v.lang === listLangVoice[indexSelect2Update]);
  }
  if (lang2VoiceC === undefined) {
    console.log('Kh√¥ng c√≥ voice ph√π h·ª£p');
  } else {
    console.log('Voice ƒë∆∞·ª£c ch·ªçn:', lang2VoiceC.lang);
  }
  checkChatGpt();
}

// ƒê·ª£i s·ª± ki·ªán voiceschanged ƒë·ªÉ g·ªçi toggleMenu1
speechSynthesis.onvoiceschanged = () => {
  toggleMenu1();
  toggleMenu2();
  console.log('lang1VoiceC:',lang1VoiceC);
  console.log('lang2VoiceC:',lang2VoiceC);
};

// Khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn, l∆∞u l·∫°i
lang1_select.addEventListener("change", function() {
    localStorage.setItem("lastSelected1", lang1_select.selectedIndex);
});

// Khi ng∆∞·ªùi d√πng thay ƒë·ªïi l·ª±a ch·ªçn, l∆∞u l·∫°i
lang2_select.addEventListener("change", function() {
    localStorage.setItem("lastSelected2", lang2_select.selectedIndex);
});


function addMessage(role, text) {
    text = text.replace(/^"(.*)"$/, '$1');// b·ªè d·∫•u ngo·∫∑c k√©p ·ªü ƒë·∫ßu v√† cu·ªëi n·∫øu c√≥
    const div = document.createElement("div");
    //div.innerHTML = `<span class='${role}'>${text}</span> <br>`;
    //div.innerHTML = `<span class="${role}">${role === "mic1-noi" ? "<br>" : ""} ${text}</span>`;
    if (daBatChatGpt===true){
      if (role.includes('mic1')){
        div.innerHTML = `<span class="${role}">${role.includes('mic1-noi') ? "<br>üü¢÷é" : ""} ${text}</span>`;
      }
      if (role.includes('mic2')){
        div.innerHTML = `<span class="${role}">${role.includes('mic2-noi') ? "<br>üë§÷é" : ""} ${text}</span>`;
      }  
    }else{
      if (role.includes('mic1')){
        div.innerHTML = `<span class="${role}">${role.includes('mic1-noi') ? "<br>üü¢" : ""} ${text}</span>`;
      }
      if (role.includes('mic2')){
        div.innerHTML = `<span class="${role}">${role.includes('mic2-noi') ? "<br>üë§" : ""} ${text}</span>`;
      }  
    }
    chatbox.appendChild(div);
    //cho div  msg.style.display = "none"; hoac = 'block' o day
    //neu demAnHienClick%2 === 1 thi none, khac thi block
    if (demAnHienClick%2 === 1){
      div.style.display = "none";
    }else{
      div.style.display = "block";
    }

    chatbox.scrollTop = chatbox.scrollHeight;
}

// H√†m ph√°t √¢m text dich
function speakTextDichCc(text,langVoice,lnoiDatTextDichCcVaMic) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();

    text = lnoiDatTextDichCcVaMic[0].innerText;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = langVoice;


    utterance.addEventListener('start', handleStart);
    utterance.addEventListener('end', handleEnd);
    utterance.addEventListener('boundary', handleBoundary);

    speechSynthesis.speak(utterance);

    function handleStart(){
      loa_button.style.backgroundImage="url('icons/loa-animation.gif')";

    }
    function handleEnd() {
      loa_button.style.backgroundImage="url('icons/loa.png')";
      lnoiDatTextDichCcVaMic[0].innerHTML = lnoiDatTextDichCcVaMic[0].innerText;
      //dong tren day gan cho lnoiDatTextDichCcVaMic[0].innerHTML
      //chi co gia tri la text, khong con mark nua de mat dau mark
    }
    function handleBoundary(event) {
        if (event.name === 'sentence') {
            // we only care about word boundaries
            return;
        }
        const wordStart = event.charIndex;
        let wordLength = event.charLength;
        if (wordLength === undefined) {
            // Safari doesn't provide charLength, so fall back to a regex to find the current word and its length (probably misses some edge cases, but good enough for this demo)
            const match = text.substring(wordStart).match(/^[a-z\d']*/i);
            wordLength = match[0].length;
        }
        // wrap word in <mark> tag
        const wordEnd = wordStart + wordLength;
        const word = text.substring(wordStart, wordEnd);
        let markedText;
        if (lnoiDatTextDichCcVaMic[1]==='mic1-dich') {  
          markedText = text.substring(0, wordStart) + '<mark class="mark1">' + word + '</mark>' + text.substring(wordEnd);
        }else{
          markedText = text.substring(0, wordStart) + '<mark class="mark2">' + word + '</mark>' + text.substring(wordEnd);
        }
        lnoiDatTextDichCcVaMic[0].innerHTML = markedText; //phan nay co ma trong resultsdichEl nen phai innerHTML
            //t them: tim cac "mark" de thuc thi ham scrollIntoView() de cuon div chua text doc
        let markElement = document.querySelector("mark");
        if (markElement){
            markElement.scrollIntoView({
                behavior: "smooth", block: "center"
            });
        }
    }


    //khi doc den cuoi thi cho innerHTML chi la text, khong con mark nua
    //de bien mat highlight

  }else{
    console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ speechSynthesis");
  }  


};

function layNoiDatTextCc(micDich){
  let allDivs,id_dat_textchay;
  if (micDich==='mic1-dich'){
    allDivs = chatbox.querySelectorAll(".mic1-dich");
  }else{
    allDivs = chatbox.querySelectorAll(".mic2-dich");
  }
  id_dat_textchay = allDivs[allDivs.length - 1];
  //console.log('tttttttttt:',micDich);
  return [id_dat_textchay,micDich] ;
}

// H√†m ƒë·ªÉ d·ªãch 
function dichTextFromTo(textDemDich, micNoi){
    //console.log('cac ts:',textDemDich, micNoi);
    const inputText = textDemDich;
    let sourceLanguage;
    let targetLanguage;
    if (micNoi==='mic1'){
        sourceLanguage = listLangVoice[indexSelect1Update].substring(0,2);
        targetLanguage = listLangVoice[indexSelect2Update].substring(0,2);
    }else{
        sourceLanguage = listLangVoice[indexSelect2Update].substring(0,2);
        targetLanguage = listLangVoice[indexSelect1Update].substring(0,2);
    }    
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200){
            const responseReturned = JSON.parse(this.responseText);
            const translations = responseReturned[0].map((text) => text[0]);
            const textDichRa  = translations.join(" ");
            console.log(textDichRa);
            //Viet textDichRa vao trong hop chat
            if (micNoi==='mic1'){
              mic1TextDich = textDichRa;
              addMessage("mic1-dich", mic1TextDich);
              let lnoiDatTextDichCcVaMic = layNoiDatTextCc("mic1-dich");/////////////////////
              loa_button.onclick = () => {
                //neu dang phat loa thi nhung
                if (window.speechSynthesis.speaking) {
                  window.speechSynthesis.cancel();
                  lnoiDatTextDichCcVaMic[0].innerHTML = lnoiDatTextDichCcVaMic[0].innerText;
                  loa_button.style.backgroundImage = "url('icons/loa.png')";

                }else{
                //neu loa da dung thi doc lai
                speakTextDichCc(mic1TextDich, lang2VoiceC,lnoiDatTextDichCcVaMic);
              }
            }
              loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n
            }else{
              mic2TextDich = textDichRa;
              addMessage("mic2-dich", mic2TextDich);
              let lnoiDatTextDichCcVaMic = layNoiDatTextCc("mic2-dich");
              loa_button.onclick = () => {
                //neu dang phat loa thi nhung
                if (window.speechSynthesis.speaking) {
                  window.speechSynthesis.cancel();
                  lnoiDatTextDichCcVaMic[0].innerHTML = lnoiDatTextDichCcVaMic[0].innerText;
                  loa_button.style.backgroundImage = "url('icons/loa.png')";
                }else{
                //neu loa da dung thi doc lai
                speakTextDichCc(mic2TextDich, lang1VoiceC,lnoiDatTextDichCcVaMic);
              }
            }
              loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n
            }
            //cho speak o sau, no se doc tren DIV cuoi cua chatbox
        }
    }
    xhttp.open("GET", url);
    xhttp.send();
};

// Nh·∫≠n gi·ªçng n√≥i t·ª´ mic1
mic1_button.onclick = () => {
    const recognition1 = new webkitSpeechRecognition();
    recognition1.lang = listLangVoice[indexSelect1Update].substring(0,2);
    recognition1.continuous = false;//
    recognition1.interimResults = false;// Ch·ªâ l·∫•y k·∫øt qu·∫£ cu·ªëi c√πng

    recognition1.onresult = async (event) => {
        const mic1TextNoi = event.results[0][0].transcript;
        console.log("B·∫°n n√≥i:", mic1TextNoi);
        addMessage("mic1-noi", mic1TextNoi);

        recognition1.stop();// D·ª´ng nh·∫≠n gi·ªçng n√≥i khi k·∫øt th√∫c 
        //dat o cho nay thi mic ios moi bien mat
        //alert(vietnameseText);

        // D·ªãch b·∫±ng google
        if (daBatChatGpt===false){
          dichTextFromTo(mic1TextNoi, 'mic1');
        }else{
          sendGptReplyAndSpeak(mic1TextNoi);
        }
        // G√°n h√†nh ƒë·ªông cho loa_button ƒë·ªÉ ph√°t l·∫°i
        //doc text trong div cuoi cung cua chatbox
        //mic1TextDich = text div cc;
    };

    recognition1.onerror = (e) => {
        console.error("L·ªói nh·∫≠n gi·ªçng n√≥i:", e.error);
    };
    recognition1.onend = () => {
      mic1_button.style.backgroundImage = "none";
    };
    recognition1.onstart = function() {// ƒëang nh·∫≠n gi·ªçng n√≥i sau khi b·∫•m mic1
      mic1_button.style.backgroundImage = "url('icons/mic1-animation.gif')"; 
    };

    recognition1.start();// B·∫Øt ƒë·∫ßu nh·∫≠n gi·ªçng n√≥i
};

// Nh·∫≠n gi·ªçng n√≥i t·ª´ mic2
mic2_button.onclick = () => {
    const recognition2 = new webkitSpeechRecognition();
    recognition2.lang = listLangVoice[indexSelect2Update].substring(0,2);
    recognition2.continuous = false;//
    recognition2.interimResults = false;// Ch·ªâ l·∫•y k·∫øt qu·∫£ cu·ªëi c√πng

    recognition2.onresult = async (event) => {
        const mic2TextNoi = event.results[0][0].transcript;
        console.log("B·∫°n n√≥i:", mic2TextNoi);
        addMessage("mic2-noi", mic2TextNoi);

        recognition2.stop();// D·ª´ng nh·∫≠n gi·ªçng n√≥i khi k·∫øt th√∫c 
        //dat o cho nay thi mic ios moi bien mat
        //alert(vietnameseText);

        // D·ªãch b·∫±ng google
        if (daBatChatGpt===false){
          dichTextFromTo(mic2TextNoi, 'mic2');
        }else{
          sendGptReplyAndSpeak(mic2TextNoi);
        }
        // G√°n h√†nh ƒë·ªông cho loa_button ƒë·ªÉ ph√°t l·∫°i
        //doc text trong div cuoi cung cua chatbox
        //mic1TextDich = text div cc;
   
    };

    recognition2.onerror = (e) => {
        console.error("L·ªói nh·∫≠n gi·ªçng n√≥i:", e.error);
    };
    recognition2.onend = () => {
      mic2_button.style.backgroundImage = "none";
    };
    recognition2.onstart = function() {// ƒëang nh·∫≠n gi·ªçng n√≥i sau khi b·∫•m mic1
      mic2_button.style.backgroundImage = "url('icons/mic1-animation.gif')"; 
    };

    recognition2.start();// B·∫Øt ƒë·∫ßu nh·∫≠n gi·ªçng n√≥i
  };

//ham nay chi cho noi ready
function speakTextDich(text,langVoice) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = langVoice;
    //utterance.lang = langVoice.lang;

    utterance.onend = () => loa_button.style.backgroundImage = "url('icons/loa.png')";
    speechSynthesis.speak(utterance);
    loa_button.style.backgroundImage = "url('icons/loa-animation.gif')";
  }else{
    console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ speechSynthesis");
  }  


};


start_button.onclick=()=>{
  //--Doan ma nay chi de mo micro trong iphone, lap top ko can
  const recognition = new webkitSpeechRecognition();
  recognition.onresult = e => {
    console.log(e.results[0][0].transcript);
    recognition.stop();
  };  

  recognition.start();
  
  //chi de kich hoat loa lan dau, 
  loa_button.onclick = () => speakTextDich("Ready!",lang2VoiceC);
  loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n

  mic1_button.disabled = false;
  mic2_button.disabled = false;   
  banphim1.disabled = false;
  banphim2.disabled = false;

  start_button.style.backgroundImage = "url('icons/started.png')";
  start_button.disabled = true;


}

function copyText(){
  if (chatbox.innerText !== ""){
    const allText = chatbox.innerText;
    navigator.clipboard.writeText(allText).then(() => {
    const label = document.getElementById("copiedLabel");
    label.style.display = "block";

    setTimeout(() => {
      label.style.display = "none";
    }, 1500);
  });

  }
}

function removeAllDivs() {
  const childDivs = chatbox.querySelectorAll("div");
  childDivs.forEach(div => div.remove());

}

function fVoiceChoIndexUpdate(iUpdate){
  let voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    console.warn("Danh s√°ch voices ch∆∞a s·∫µn s√†ng. ƒê·ª£i s·ª± ki·ªán voiceschanged...");
    return;
  }
  let langVoiceC; 
  if (listLangVoice[iUpdate]==='en-US'){
    langVoiceC = voices.find(v => v.lang === 'en-US' && (v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Karen') || v.name.includes('Zira')));
    if (langVoiceC===undefined){
      langVoiceC = voices.find(v => v.lang === listLangVoice[iUpdate]);
    }    
  }else{
    langVoiceC = voices.find(v => v.lang === listLangVoice[iUpdate]);
  }
  if (langVoiceC === undefined) {
    console.log('Kh√¥ng c√≥ voice ph√π h·ª£p');
  } else {
    console.log('Voice ƒë∆∞·ª£c ch·ªçn:', langVoiceC.lang);
  }
  return langVoiceC;
}
lang1VoiceC = fVoiceChoIndexUpdate(indexSelect1Update);
lang2VoiceC = fVoiceChoIndexUpdate(indexSelect2Update);


//÷é ÷é ‚öõÔ∏è üîìüîí



</script>

<script src="index.js"></script>

</body>
</html>

