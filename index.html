<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat v·ªõi GPT (Gi·ªçng n√≥i + B√†n ph√≠m)</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
#chatbox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }

#inputArea {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

textarea {
  flex: 1;
  min-width: 0;
  height: 36px;
}

.button-group {
  display: flex;
  gap: 4px; /* kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
}

button {
  height: 42px;
  white-space: nowrap;
}
/*
.user { color: blue; font-weight: bold; }
.gpt { color: green; font-weight: bold; }
*/
.user {
  color: gray;
}

#start_button{
width: 42px; /* K√≠ch th∆∞·ªõc n√∫t */
height: 42px;
border-radius: 0%; /* L√†m cho n√∫t tr√≤n */
background-image: url("icons/mic.gif"); /* ·∫¢nh b√™n trong */
background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
background-position: center;
border: 3px solid #333; /* Vi·ªÅn */
cursor: pointer;
align-items: center;
justify-content: center;
}

#listen_button {
width: 42px; /* K√≠ch th∆∞·ªõc n√∫t */
height: 42px;
border-radius: 0%; /* L√†m cho n√∫t tr√≤n */
background-image: url("icons/bot.png"); /* ·∫¢nh b√™n trong */
background-size: cover; /* ƒê·∫£m b·∫£o ·∫£nh ph·ªß ƒë·∫ßy */
background-position: center;
border: 3px solid #333; /* Vi·ªÅn */
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}

</style>
</head>
<body>
<h2 onclick="tieng_chon_chat()">ü§ñ Chat with GPT in <button id="langChonText" style="color: blue;font-size:20px">Vietnamese</button></h2>

<div id="chatbox"></div>

<div id="inputArea">
    <textarea id="textInput" type="text" placeholder="G√µ tin nh·∫Øn ho·∫∑c b·∫•m mic ƒë·ªÉ n√≥i..." /></textarea>
    <div class="button-group">
        <button onclick="sendText()"> ‚û§ </button>
        <button id="start_button" onclick="toggleMic()" ></button>
        <button id="listen_button"></button>
    </div>
</div>

<script>
//===Tien them
const dnaToBinaryMap = {
'A': '00',
'C': '01',
'G': '10',
'T': '11'
};

function dnaToBinarySequence(dna) {
    return dna
    .split('')
    .map(base => dnaToBinaryMap[base] || '')
    .join('');
}

function binaryToText(binary) {
    let text = '';
    for (let i = 0; i < binary.length; i += 8) {
        const byte = binary.slice(i, i + 8);
        text += String.fromCharCode(parseInt(byte, 2));
    }
    return text;
}

function decodeDNA(textkhoaapi) {
    const binary = dnaToBinarySequence(textkhoaapi);
    const text = binaryToText(binary);
    return text;
}

let langChatN = 0;
let langChatSpeak = 'vi-VN';
let langChatText = 'vi';

const textkhoaapi = "CTATCGGTAGTCCTAACTAGCGTTCGGGAGTCCGCCCTAACCGACTCTCGGGCATACAACCGCCCAGTCCAACATACAAGCTCCCCCACACGCATCCTCGCGGGCACACGTCCGCACCACCAACCGGACACACCCGCGAGCGGACAGTCGATCCATCCGGCAGGATCGATAACTGACGGTCACACAGCATCACGGCCACGATCAATACATGCCTCCCTCGCGGACCGACAATATCTCACTCCGGATCTCGGGCCATATCTCAATCAGACGTAATGAAGTCCATTCAATCGCCCGTCCATCATAGATGCATATCAGTCTCACCCCATCCCCCAATATCAAGCGTACGAGCGGTCACGCAGGCAGGATACATCACGGCATCACCACCAACCCCTCAAGCCGCCGGCCAGGCCACCGAGCCAACATCCATGCAAGCATTCATCCTCACTATCTAACTAAATGACCACCATAAGTCAGTCCGTCCCCGCGAGCACTATAGCTCCCGGCCGCTATAGCGTTCTACATCAATCACCGCCACTCTCACGGGCCCTATGCCCCACACGCGAGATATCACACGCACCACCTCCCAGCCTAGCAGTCCGCCGTCATCTCGGTCATGCTCGCTCGCCCACGTGCCCCCTACCAGTCGTTCCCCCAAC";
//===Tien them

const apiKey = decodeDNA(textkhoaapi)

const chatbox = document.getElementById("chatbox");
const textInput = document.getElementById("textInput");

//chatbox.innerHTML += `<div class="user" style="text-align:right;"><b>‚ùî</b> ${pair.user}</div>`;
//chatbox.innerHTML += `<div class="bot" style="text-align:left;"><b>üí¨</b> ${pair.bot}</div>`;

function addMessage(role, text) {
    const div = document.createElement("div");
    div.innerHTML = `<span class="${role}">${role === "user" ? "<br>‚ùî" : "üí¨"} ${text}</span>`;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}
const hauto = "D·ªãch c√¢u tr√™n ƒë√¢y sang ti·∫øng Anh m√† kh√¥ng c·∫ßn gi·∫£i th√≠ch." 

async function sendToGPT(message) {
    const res = await fetch("https://your-server.com/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
    });
    const data = await res.json();
    return data.reply;
}

async function sendText() {
    const msg = textInput.value.trim();
    if (!msg) return;
    msg = msg + hauto;
    alert(msg);
    addMessage("user", msg);
    textInput.value = "";
    const reply = await sendToGPT(msg);
    addMessage("gpt", reply);
    speak(reply);
}

// SPEECH TO TEXT (Voice Input)
let recognition;
let listening = false;

function toggleMic() {
    if (!listening) {
        startRecognition();
        startVoiceChat();
    } else {
        stopRecognition();
    }
}

function startRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechRecognition.");
        return;
    }
    recognition = new webkitSpeechRecognition();
    recognition.lang = langChatSpeak;
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = async (event) => {
    const transcript = event.results[0][0].transcript;
    addMessage("user", transcript);
    const reply = await sendToGPT(transcript + hauto);
    addMessage("gpt", reply);
    speak(reply);
    };

    recognition.onstart = () => listening = true;
    recognition.onend = () => listening = false;

    recognition.start();
}

function stopRecognition() {
    if (recognition) recognition.stop();
}

// TEXT TO SPEECH
function speak(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langChatSpeak;
    speechSynthesis.speak(utter);
}

//DN ham sendToGPT
async function sendToGPT(prompt) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }]
        }),
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;
    return reply;
}


//DN ham handleUserSpeech
async function handleUserSpeech(text) {
    log(`<b>B·∫°n:</b> ${text}`);

    const reply = await sendToGPT(text);
    log(`<b>GPT:</b> ${reply}`);

    return new Promise((resolve) => {
        const utter = new SpeechSynthesisUtterance(reply);
        utter.lang = langChatSpeak;
        utter.onend = () => resolve();
        speechSynthesis.speak(utter);
    });
}

//DN ham recordOnce
function recordOnce() {
    return new Promise((resolve, reject) => {
        recognition.start();

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            recognition.stop();
            resolve(transcript);
        };

        recognition.onerror = (e) => {
            recognition.stop();
            reject(e);
        };
    });
}

// khi nhap mic thi thuc thi ham sau:
async function startVoiceChat() {
    log("‚è≥ ƒêang l·∫Øng nghe b·∫°n...");
    while (true) {
        try {
            const userSpeech = await recordOnce();
            await handleUserSpeech(userSpeech);
        } catch (err) {
            console.error("L·ªói:", err);
            break;
        }
    }
}
//DN ham tieng_chon_chat
function tieng_chon_chat(){
    langChatN += 1; 
    if (langChatN % 7 === 1) {
        langChatSpeak = 'en-US';
        langChatText = 'en';
        document.getElementById("langChonText").innerText="English";
    } else if (langChatN % 7 === 2) {
        langChatSpeak = 'fr-FR';
        langChatText = 'fr';
        document.getElementById("langChonText").innerText="French";
    } else if (langChatN % 7 === 3) {
        langChatSpeak = 'da-DK';
        langChatText = 'da';
        document.getElementById("langChonText").innerText="Denmark";
    } else if (langChatN % 7 === 4) {
        langChatSpeak = 'nl-NL';
        langChatText = 'nl';
        document.getElementById("langChonText").innerText="Nederlands";
    } else if (langChatN % 7 === 5) {
        langChatSpeak = 'de-DE';
        langChatText = 'de';
        document.getElementById("langChonText").innerText="German";
    } else if (langChatN % 7 === 6) {
        langChatSpeak = 'zh-TW';
        langChatText = 'zh';
        document.getElementById("langChonText").innerText="Taiwan";
    } else if (langChatN % 7 === 0) {
        langChatSpeak = 'vi-VN';
        langChatText = 'vi';
        document.getElementById("langChonText").innerText="Vietnamese";
    }; 
}
</script>
</body>
</html>
